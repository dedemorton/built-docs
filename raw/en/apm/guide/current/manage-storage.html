<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Manage storage | APM User Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="APM User Guide [master]"/>
<link rel="up" href="how-to-guides.html" title="How-to guides"/>
<link rel="prev" href="ingest-pipelines.html" title="Parse data using ingest pipelines"/>
<link rel="next" href="apm-tune-elasticsearch.html" title="Tune Elasticsearch for data ingestion"/>
<meta name="DC.type" content="Learn/Docs/APM Guide/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM User Guide [master]</a></span>
»
<span class="breadcrumb-link"><a href="how-to-guides.html">How-to guides</a></span>
»
<span class="breadcrumb-node">Manage storage</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ingest-pipelines.html">« Parse data using ingest pipelines</a>
</span>
<span class="next">
<a href="apm-tune-elasticsearch.html">Tune Elasticsearch for data ingestion »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="manage-storage"></a>Manage storage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h2>
</div></div></div>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="manage-storage.html#storage-guide" title="Storage and sizing guide">Storage and sizing guide</a>
</li>
<li class="listitem">
<a class="xref" href="manage-storage.html#processing-and-performance" title="Processing and performance">Processing and performance</a>
</li>
<li class="listitem">
<a class="xref" href="manage-storage.html#reduce-apm-storage" title="Reduce storage">Reduce storage</a>
</li>
<li class="listitem">
<a class="xref" href="manage-storage.html#manage-indices-in-kibana" title="Manage Indices via Kibana">Manage Indices via Kibana</a>
</li>
<li class="listitem">
<a class="xref" href="manage-storage.html#update-data" title="Update existing data">Update existing data</a>
</li>
</ul>
</div>
<h3><a id="storage-guide"></a>Storage and sizing guide<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h3>
<p>APM processing and storage costs are largely dominated by transactions, spans, and stack frames.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="data-model-transactions.html" title="Transactions"><span class="strong strong"><strong>Transactions</strong></span></a> describe an event captured by an Elastic APM agent instrumenting a service.
They are the highest level of work being measuring within a service.
</li>
<li class="listitem">
<a class="xref" href="data-model-spans.html" title="Spans"><span class="strong strong"><strong>Spans</strong></span></a> belong to transactions. They measure from the start to end of an activity,
and contain information about a specific code path that has been executed.
</li>
<li class="listitem">
<span class="strong strong"><strong>Stack frames</strong></span> belong to spans. Stack frames represent a function call on the call stack,
and include attributes like function name, file name and path, line number, etc.
Stack frames can heavily influence the size of a span.
</li>
</ul>
</div>
<h4><a id="_typical_transactions"></a>Typical transactions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>Due to the high variability of APM data, it&#8217;s difficult to classify a transaction as typical.
Regardless, this guide will attempt to classify Transactions as <em>Small</em>, <em>Medium</em>, or <em>Large</em>,
and make recommendations based on those classifications.</p>
<p>The size of a transaction depends on the language, agent settings, and what services the agent instruments.
For instance, an agent auto-instrumenting a service with a popular tech stack
(web framework, database, caching library, etc.) is more likely to generate bigger transactions.</p>
<p>In addition, all agents support manual instrumentation.
How little or much you use these APIs will also impact what a typical transaction looks like.</p>
<p>If your sampling rate is very small, transactions will be the dominate storage cost.</p>
<p>Here&#8217;s a speculative reference:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Transaction size</th>
<th align="left" valign="top">Number of Spans</th>
<th align="left" valign="top">Number of stack frames</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p><em>Small</em></p></td>
<td align="left" valign="top"><p>5-10</p></td>
<td align="left" valign="top"><p>5-10</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><em>Medium</em></p></td>
<td align="left" valign="top"><p>15-20</p></td>
<td align="left" valign="top"><p>15-20</p></td>
</tr>
<tr>
<td align="left" valign="top"><p><em>Large</em></p></td>
<td align="left" valign="top"><p>30-40</p></td>
<td align="left" valign="top"><p>30-40</p></td>
</tr>
</tbody>
</table>
</div>
<p>There will always be transaction outliers with hundreds of spans or stack frames, but those are very rare.
Small transactions are the most common.</p>
<h4><a id="_typical_storage"></a>Typical storage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>Consider the following typical storage reference.
These numbers do not account for Elasticsearch compression.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
1 unsampled transaction is <span class="strong strong"><strong>~1 Kb</strong></span>
</li>
<li class="listitem">
1 span with 10 stack frames is <span class="strong strong"><strong>~4 Kb</strong></span>
</li>
<li class="listitem">
1 span with 50 stack frames is <span class="strong strong"><strong>~20 Kb</strong></span>
</li>
<li class="listitem">
1 transaction with 10 spans, each with 10 stack frames is <span class="strong strong"><strong>~50 Kb</strong></span>
</li>
<li class="listitem">
1 transaction with 25 spans, each with 25 spans is <span class="strong strong"><strong>250-300 Kb</strong></span>
</li>
<li class="listitem">
100 transactions with 10 spans, each with 10 stack frames, sampled at 90% is <span class="strong strong"><strong>600 Kb</strong></span>
</li>
</ul>
</div>
<p>APM data compresses quite well, so the storage cost in Elasticsearch will be considerably less:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Indexing 100 unsampled transactions per second for 1 hour results in 360,000 documents. These documents use around <span class="strong strong"><strong>50 Mb</strong></span> of disk space.
</li>
<li class="listitem">
Indexing 10 transactions per second for 1 hour, each transaction with 10 spans, each span with 10 stack frames, results in 396,000 documents. These documents use around <span class="strong strong"><strong>200 Mb</strong></span> of disk space.
</li>
<li class="listitem">
Indexing 25 transactions per second for 1 hour, each transaction with 25 spans, each span with 25 stack frames, results in 2,340,000 documents. These documents use around <span class="strong strong"><strong>1.2 Gb</strong></span> of disk space.
</li>
</ul>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>These examples were indexing the same data over and over with minimal variation. Because of that, the compression ratios observed of 80-90% are somewhat optimistic.</p>
</div>
</div>
<h3><a id="processing-and-performance"></a>Processing and performance<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h3>
<p>APM Server performance depends on a number of factors: memory and CPU available,
network latency, transaction sizes, workload patterns,
agent and server settings, versions, and protocol.</p>
<p>Let&#8217;s look at a simple example that makes the following assumptions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The load is generated in the same region as where APM Server and Elasticsearch are deployed.
</li>
<li class="listitem">
We&#8217;re using the default settings in cloud.
</li>
<li class="listitem">
A small number of agents are reporting.
</li>
</ul>
</div>
<p>This leaves us with relevant variables like payload and instance sizes.
See the table below for approximations.
As a reminder, events are
<a class="xref" href="data-model-transactions.html" title="Transactions">transactions</a> and
<a class="xref" href="data-model-spans.html" title="Spans">spans</a>.</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Transaction/Instance</th>
<th align="left" valign="top">512Mb Instance</th>
<th align="left" valign="top">2Gb Instance</th>
<th align="left" valign="top">8Gb Instance</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>Small transactions</p>
<p><em>5 spans with 5 stack frames each</em></p></td>
<td align="left" valign="top"><p>600 events/second</p></td>
<td align="left" valign="top"><p>1200 events/second</p></td>
<td align="left" valign="top"><p>4800 events/second</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Medium transactions</p>
<p><em>15 spans with 15 stack frames each</em></p></td>
<td align="left" valign="top"><p>300 events/second</p></td>
<td align="left" valign="top"><p>600 events/second</p></td>
<td align="left" valign="top"><p>2400 events/second</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Large transactions</p>
<p><em>30 spans with 30 stack frames each</em></p></td>
<td align="left" valign="top"><p>150 events/second</p></td>
<td align="left" valign="top"><p>300 events/second</p></td>
<td align="left" valign="top"><p>1400 events/second</p></td>
</tr>
</tbody>
</table>
</div>
<p>In other words, a 512 Mb instance can process \~3 Mbs per second,
while an 8 Gb instance can process ~20 Mbs per second.</p>
<p>APM Server is CPU bound, so it scales better from 2 Gb to 8 Gb than it does from 512 Mb to 2 Gb.
This is because larger instance types in Elastic Cloud come with much more computing power.</p>
<p>Don&#8217;t forget that the APM Server is stateless.
Several instances running do not need to know about each other.
This means that with a properly sized Elasticsearch instance, APM Server scales out linearly.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>RUM deserves special consideration. The RUM agent runs in browsers, and there can be many thousands reporting to an APM Server with very variable network latency.</p>
</div>
</div>
<h3><a id="reduce-apm-storage"></a>Reduce storage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h3>
<p>The amount of storage for APM data depends on several factors:
the number of services you are instrumenting, how much traffic the services see, agent and server settings,
and the length of time you store your data.</p>
<h4><a id="_reduce_the_sample_rate"></a>Reduce the sample rate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>The transaction sample rate directly influences the number of documents (more precisely, spans) to be indexed.
It is the easiest way to reduce storage.</p>
<p>The transaction sample rate is a configuration setting of each agent.
Reducing it does not affect the collection of metrics such as <em>Transactions per second</em>.</p>
<h4><a id="_reduce_collected_stacktrace_information"></a>Reduce collected stacktrace information<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>Elastic APM agents collect <code class="literal">stacktrace</code> information under certain circumstances.
This can be very helpful in identifying issues in your code,
but it also comes with an overhead at collection time and increases the storage usage.</p>
<p>Stacktrace collection settings are managed in each agent.</p>
<h4><a id="_delete_data"></a>Delete data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>You might want to only keep data for a defined time period.
This might mean deleting old documents periodically,
deleting data collected for specific services or customers,
or deleting specific indices.</p>
<p>Depending on your use case,
you can delete data periodically with <a class="xref" href="manage-storage.html#delete-data-with-ilm" title="Delete data with ILM">index lifecycle management</a>,
<a href="/guide/en/elasticsearch/client/curator/current" class="ulink" target="_top">Curator</a>, the <a href="/guide/en/elasticsearch/reference/master/docs-delete-by-query.html" class="ulink" target="_top">Delete By Query API</a>,
or in the <a href="/guide/en/kibana/master/managing-indices.html" class="ulink" target="_top">Kibana Index Management UI</a>.</p>
<h5><a id="delete-data-with-ilm"></a>Delete data with ILM<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h5>
<p>Index Lifecycle management (ILM) enables you to automate how you want to manage your indices over time.
You can base actions on factors such as shard size and performance requirements.
See <a class="xref" href="ilm-how-to.html" title="Index lifecycle management (ILM)">Customize index lifecycle management</a> to learn more.</p>
<h5><a id="delete-data-query"></a>Delete data matching a query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h5>
<p>You can delete documents matching a specific query.
For example, all documents with a given <code class="literal">context.service.name</code> use the following request:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">POST /*-apm-*/_delete_by_query
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "service.name": {
              "value": "old-service-name"
            }
          }
        }
      ]
    }
  }
}</pre>
</div>
<p>See <a href="/guide/en/elasticsearch/reference/master/docs-delete-by-query.html" class="ulink" target="_top">delete by query</a> for further information on this topic.</p>
<h5><a id="delete-data-in-kibana"></a>Delete data via Kibana Index Management UI<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h5>
<p>Select the indices you want to delete, and click <span class="strong strong"><strong>Manage indices</strong></span> to see the available actions.
Then click <span class="strong strong"><strong>delete indices</strong></span>.</p>
<h3><a id="manage-indices-in-kibana"></a>Manage Indices via Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h3>
<p>Kibana&#8217;s <a href="/guide/en/elasticsearch/reference/master/index-mgmt.html" class="ulink" target="_top">index management</a> allows you to manage your cluster&#8217;s
indices, data streams, index templates, and much more.</p>
<h3><a id="update-data"></a>Update existing data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h3>
<p>You might want to update documents that are already indexed.
For example, if you your service name was set incorrectly.</p>
<p>To do this, you can use the <a href="/guide/en/elasticsearch/reference/master/docs-update-by-query.html" class="ulink" target="_top">Update By Query API</a>.</p>
<h4><a id="_rename_a_service"></a>Rename a service<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-server/edit/master/docs/manage-storage.asciidoc">edit</a></h4>
<p>To rename a service, send the following request:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST *-apm-*/_update_by_query
{
  "query": {
    "term": {
      "service.name": {
        "value": "current-service-name"
      }
    }
  },
  "script": {
    "source": "ctx._source.service.name = 'new-service-name'",
    "lang": "painless"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/6.console"></div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Remember to also change the service name in the <a href="/guide/en/apm/agent/index.html" class="ulink" target="_top">APM agent configuration</a>.</p>
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ingest-pipelines.html">« Parse data using ingest pipelines</a>
</span>
<span class="next">
<a href="apm-tune-elasticsearch.html">Tune Elasticsearch for data ingestion »</a>
</span>
</div>
</div>
</body>
</html>
